<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DVista ‚Äì Dataset Intake</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #050816;
        --card: #0f172a;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.15);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --danger: #f97373;
        --border: rgba(148, 163, 184, 0.3);
        --radius: 10px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #1d2a3f 0, #020617 50%, #000 100%);
        color: var(--text);
      }

      .app {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      h1 {
        font-size: 28px;
        margin: 0 0 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      h1 span.logo-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: linear-gradient(135deg, #38bdf8, #a855f7);
        box-shadow: 0 0 12px rgba(56, 189, 248, 0.7);
      }

      .subtitle {
        margin: 0 0 24px;
        color: var(--muted);
        font-size: 14px;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 360px) minmax(0, 1fr);
        gap: 16px;
      }

      @media (max-width: 840px) {
        .layout {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .card {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.98));
        border-radius: var(--radius);
        border: 1px solid var(--border);
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.8);
        padding: 16px 18px 18px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .card-title {
        font-size: 15px;
        font-weight: 600;
      }

      .card-tag {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(56, 189, 248, 0.6);
        color: #7dd3fc;
        background: rgba(15, 23, 42, 0.9);
      }

      label {
        display: block;
        font-size: 13px;
        margin-bottom: 4px;
      }

      .input-row {
        margin-bottom: 10px;
      }

      input[type="file"],
      input[type="text"] {
        width: 100%;
        font-size: 13px;
        padding: 7px 9px;
        border-radius: 7px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
        color: var(--text);
        outline: none;
      }

      input[type="file"]:focus,
      input[type="text"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
      }

      .hint {
        font-size: 11px;
        color: var(--muted);
        margin-top: 2px;
      }

      button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 7px 14px;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        color: #020617;
        background: linear-gradient(135deg, #38bdf8, #a855f7);
        box-shadow: 0 10px 24px rgba(56, 189, 248, 0.45);
      }

      button:disabled {
        opacity: 0.7;
        cursor: default;
        box-shadow: none;
      }

      .status {
        min-height: 18px;
        font-size: 12px;
        margin-top: 6px;
      }

      .status.error {
        color: var(--danger);
      }

      .status.ok {
        color: #4ade80;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
        border: 1px solid rgba(148, 163, 184, 0.7);
        color: var(--muted);
        background: rgba(15, 23, 42, 0.9);
        margin-right: 4px;
      }

      .pill-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #22c55e;
      }

      .pill-danger {
        border-color: rgba(248, 113, 113, 0.9);
        color: #fecaca;
      }

      .pill-danger .pill-dot {
        background: #ef4444;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
        font-size: 11.5px;
      }

      th,
      td {
        padding: 4px 6px;
        border-bottom: 1px solid rgba(30, 64, 175, 0.6);
        text-align: left;
        white-space: nowrap;
      }

      th {
        font-weight: 600;
        color: #bfdbfe;
        background: rgba(15, 23, 42, 0.9);
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.8);
      }

      .scroll {
        max-height: 260px;
        overflow: auto;
        border-radius: 8px;
        border: 1px solid rgba(30, 64, 175, 0.7);
        background: radial-gradient(circle at top, #020617, #020617);
        margin-top: 6px;
      }

      .section-title {
        font-size: 13px;
        font-weight: 500;
        margin-top: 4px;
        margin-bottom: 2px;
      }

      .sanity-list {
        margin: 4px 0 0;
        padding-left: 16px;
        font-size: 12px;
      }

      .badge {
        display: inline-flex;
        font-size: 11px;
        border-radius: 999px;
        padding: 2px 8px;
        background: var(--accent-soft);
        color: #e0f2fe;
        border: 1px solid rgba(56, 189, 248, 0.7);
        margin-left: 4px;
      }

      .muted {
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="app">
      <h1>
        <span class="logo-dot"></span>
        DVista ‚Äì Smart Dataset Intake
      </h1>
      <p class="subtitle">
        STEP 1 ¬∑ Upload all competition CSVs, tell DVista your target column, and get an instant,
        Kaggle-style overview of each dataset.
      </p>

      <div class="layout">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Upload datasets</div>
            <span class="card-tag">STEP 1 ¬∑ Intake</span>
          </div>

          <form id="intake-form">
            <div class="input-row">
              <label for="csv-file">CSV file(s)</label>
              <input id="csv-file" name="file" type="file" accept=".csv" multiple required />
              <div class="hint">Select all competition CSVs together (train, test, lookup tables‚Ä¶).</div>
            </div>

            <div class="input-row">
              <label for="target-column">Target column name (optional for now)</label>
              <input
                id="target-column"
                name="target_column"
                type="text"
                placeholder="e.g. audience_count"
              />
              <div class="hint">
                DVista will treat any dataset containing this column as a FACT table. You can leave
                it empty if you just want a quick overview.
              </div>
            </div>

            <button id="submit-btn" type="submit">
              <span>Analyze Datasets</span>
            </button>
          </form>

          <div id="status" class="status"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              Uploaded datasets
              <span id="dataset-count" class="badge" style="display: none"></span>
            </div>
          </div>

          <div id="summary">
            <p class="muted">No datasets analyzed yet. Upload CSVs to see roles and stats.</p>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 16px">
        <div class="card-header">
          <div class="card-title">Per-dataset details & EDA</div>
        </div>

        <div style="display: grid; grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr); gap: 12px">
          <div id="datasets-list" class="scroll" style="max-height: 320px; padding: 6px 4px"></div>

          <div class="scroll" style="max-height: 320px; padding: 6px 8px">
            <div class="section-title">STEP 3 ¬∑ EDA Overview</div>
            <div id="eda-summary" class="muted" style="font-size: 12px">
              Select a dataset and click ‚ÄúRun EDA‚Äù to see stats and plots here.
            </div>
            <div id="eda-plots" style="margin-top: 6px; font-size: 11px"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 16px">
        <div class="card-header">
          <div class="card-title">STEP 4 ¬∑ Problem Identification</div>
          <span class="card-tag">Required</span>
        </div>

        <div style="display: grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 16px">
          <div>
            <div class="section-title">Select Problem Type</div>
            <form id="problem-type-form" style="font-size: 12px">
              <div class="input-row">
                <label for="problem-type-dataset">Select Dataset</label>
                <select
                  id="problem-type-dataset"
                  name="dataset_id"
                  style="width: 100%; padding: 6px; border-radius: 6px; background: rgba(15,23,42,0.9); color: var(--text); border: 1px solid rgba(148,163,184,0.6)"
                  required
                >
                  <option value="">-- Select dataset --</option>
                </select>
              </div>

              <div class="input-row">
                <label for="problem-type">Problem Type</label>
                <select
                  id="problem-type"
                  name="problem_type"
                  style="width: 100%; padding: 6px; border-radius: 6px; background: rgba(15,23,42,0.9); color: var(--text); border: 1px solid rgba(148,163,184,0.6)"
                  required
                >
                  <option value="">-- Select problem type --</option>
                  <option value="classification">1Ô∏è‚É£ Classification (Predict category/class)</option>
                  <option value="regression">2Ô∏è‚É£ Regression (Predict continuous value)</option>
                  <option value="clustering">3Ô∏è‚É£ Clustering (Group similar data)</option>
                  <option value="dimensionality_reduction">4Ô∏è‚É£ Dimensionality Reduction (Reduce features)</option>
                  <option value="anomaly_detection">5Ô∏è‚É£ Anomaly/Outlier Detection (Detect unusual patterns)</option>
                  <option value="recommendation">6Ô∏è‚É£ Recommendation Systems (Suggest items)</option>
                  <option value="time_series">7Ô∏è‚É£ Time Series Forecasting (Predict future values)</option>
                </select>
                <div class="hint">
                  Select the type of ML problem you want to solve with this dataset.
                </div>
              </div>

              <div class="input-row" id="problem-subtype-row" style="display: none">
                <label for="problem-subtype">Classification Subtype</label>
                <select
                  id="problem-subtype"
                  name="problem_subtype"
                  style="width: 100%; padding: 6px; border-radius: 6px; background: rgba(15,23,42,0.9); color: var(--text); border: 1px solid rgba(148,163,184,0.6)"
                >
                  <option value="">-- Select subtype --</option>
                  <option value="binary_classification">Binary Classification (Yes/No, 2 classes)</option>
                  <option value="multiclass_classification">Multi-class Classification (3+ classes)</option>
                  <option value="multilabel_classification">Multi-label Classification (Multiple tags)</option>
                </select>
                <div class="hint">
                  Required for classification problems.
                </div>
              </div>

              <button id="problem-type-submit-btn" type="submit" style="width: 100%; margin-top: 8px">
                Save Problem Type
              </button>
            </form>
            <div id="problem-type-status" class="status" style="margin-top: 6px"></div>
          </div>

          <div>
            <div class="section-title">Problem Type Information</div>
            <div id="problem-type-info" class="muted" style="font-size: 12px; line-height: 1.6">
              <p><strong>Select a problem type to see details:</strong></p>
              <ul class="sanity-list" style="margin-top: 8px">
                <li><strong>Classification:</strong> Spam detection, fraud detection, disease prediction</li>
                <li><strong>Regression:</strong> House price, salary prediction, temperature forecasting</li>
                <li><strong>Clustering:</strong> Customer segmentation, document grouping</li>
                <li><strong>Dimensionality Reduction:</strong> PCA, data visualization, noise removal</li>
                <li><strong>Anomaly Detection:</strong> Fraud detection, network intrusion, fault detection</li>
                <li><strong>Recommendation:</strong> Movie/product/music recommendations</li>
                <li><strong>Time Series:</strong> Stock prices, sales forecasting, weather prediction</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

    </div>

    <script>
      const form = document.getElementById("intake-form");
      const statusEl = document.getElementById("status");
      const submitBtn = document.getElementById("submit-btn");
      const summaryEl = document.getElementById("summary");
      const datasetCountEl = document.getElementById("dataset-count");
      const datasetsListEl = document.getElementById("datasets-list");
      const edaSummaryEl = document.getElementById("eda-summary");
      const edaPlotsEl = document.getElementById("eda-plots");

      function setStatus(message, type = "") {
        statusEl.textContent = message;
        statusEl.className = "status " + (type || "");
      }

      function formatPct(value) {
        if (value === null || value === undefined || isNaN(value)) return "‚Äî";
        return (value * 100).toFixed(1) + "%";
      }

      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById("csv-file");
        const targetInput = document.getElementById("target-column");
        const files = fileInput.files;
        const target = targetInput.value.trim();

        if (!files || !files.length) {
          setStatus("Please select at least one CSV file.", "error");
          return;
        }

        const formData = new FormData();
        Array.from(files).forEach((f) => formData.append("files", f));
        if (target) formData.append("target_column", target);

        submitBtn.disabled = true;
        setStatus("Running intake‚Ä¶", "");

        try {
          const resp = await fetch("/api/upload-datasets", {
            method: "POST",
            body: formData,
          });

          if (!resp.ok) {
            const errText = await resp.text();
            let msg = "Request failed: " + resp.status;
            try {
              const json = JSON.parse(errText);
              if (json.detail) msg = json.detail;
            } catch (_) {
              // ignore parsing errors
            }
            throw new Error(msg);
          }

          const data = await resp.json();
          renderDatasetsOverview(data.datasets || []);
          setStatus("Dataset analysis completed successfully.", "ok");
        } catch (err) {
          console.error(err);
          setStatus(err.message || "Something went wrong.", "error");
        } finally {
          submitBtn.disabled = false;
        }
      });

      let currentDatasets = [];

      function renderDatasetsOverview(datasets) {
        currentDatasets = datasets;
        if (!datasets.length) {
          summaryEl.innerHTML = "<p class='muted'>No datasets analyzed yet.</p>";
          datasetCountEl.style.display = "none";
          datasetsListEl.innerHTML = "";
          edaSummaryEl.textContent =
            "Select a dataset and click ‚ÄúRun EDA‚Äù to see stats and plots here.";
          edaPlotsEl.innerHTML = "";
          return;
        }

        datasetCountEl.style.display = "inline-flex";
        datasetCountEl.textContent = `${datasets.length} dataset(s)`;

        // High-level summary pills
        const facts = datasets.filter((d) => d.role === "fact").length;
        const dims = datasets.filter((d) => d.role === "dimension").length;
        const txs = datasets.filter((d) => d.role === "transaction").length;

        summaryEl.innerHTML =
          `<div class="pill"><span class="pill-dot"></span><span>${datasets.length} total datasets</span></div>` +
          `<div class="pill"><span class="pill-dot"></span><span>${facts} FACT ¬∑ ${dims} DIMENSION ¬∑ ${txs} TRANSACTION</span></div>`;

        // Detailed cards
        datasetsListEl.innerHTML = "";
        datasets.forEach((d) => {
          const card = document.createElement("div");
          card.style.borderBottom = "1px solid rgba(30,64,175,0.6)";
          card.style.padding = "6px 4px 8px";

          const title = document.createElement("div");
          title.style.display = "flex";
          title.style.justifyContent = "space-between";
          title.style.alignItems = "center";
          title.innerHTML =
            `<span><strong>${escapeHtml(d.filename)}</strong></span>` +
            `<span class="badge">${escapeHtml(d.role.toUpperCase())}</span>`;
          card.appendChild(title);

          const meta = document.createElement("div");
          meta.className = "muted";
          meta.style.fontSize = "11px";
          meta.style.marginTop = "2px";
          meta.textContent = `${d.summary.n_rows} rows ¬∑ ${d.summary.n_cols} columns ¬∑ target: ${
            d.target_present === "yes" ? "present" : "absent"
          }`;
          card.appendChild(meta);

          const actions = document.createElement("div");
          actions.style.marginTop = "4px";
          const btn = document.createElement("button");
          btn.type = "button";
          btn.style.fontSize = "11px";
          btn.style.padding = "4px 10px";
          btn.textContent = "Run EDA";
          btn.addEventListener("click", () => runEdaForDataset(d.id));
          actions.appendChild(btn);
          card.appendChild(actions);

          datasetsListEl.appendChild(card);
        });
      }

      async function runEdaForDataset(datasetId) {
        const targetInput = document.getElementById("target-column");
        const target = targetInput.value.trim();

        const formData = new FormData();
        formData.append("dataset_id", String(datasetId));
        if (target) formData.append("target_column", target);

        edaSummaryEl.textContent = "Running EDA‚Ä¶";
        edaPlotsEl.innerHTML = "";

        try {
          const resp = await fetch("/api/eda", {
            method: "POST",
            body: formData,
          });
          if (!resp.ok) {
            const errText = await resp.text();
            let msg = "Request failed: " + resp.status;
            try {
              const json = JSON.parse(errText);
              if (json.detail) msg = json.detail;
            } catch (_) {}
            throw new Error(msg);
          }
          const eda = await resp.json();
          renderEda(eda);
        } catch (err) {
          console.error(err);
          edaSummaryEl.textContent = err.message || "Failed to run EDA.";
          edaPlotsEl.innerHTML = "";
        }
      }

      function renderEda(eda) {
        if (!eda || !eda.summary) {
          edaSummaryEl.textContent = "No EDA summary available.";
          edaPlotsEl.innerHTML = "";
          return;
        }

        const s = eda.summary;
        const shape = s.shape || {};
        const outliersIqr = s.outliers_iqr || {};
        const outliersZscore = s.outliers_zscore || {};
        const numCols = Object.keys(s.numeric || {}).length;
        const catCols = Object.keys(s.categorical || {}).length;
        const corrAnalysis = s.correlation_analysis || {};
        const numericAdvanced = s.numeric_advanced || {};

        // Build summary HTML with advanced stats
        let summaryHtml = 
          `<div><span class="muted">Shape:</span> <strong>${shape.n_rows ?? "?"}</strong> rows √ó <strong>${
            shape.n_cols ?? "?"
          }</strong> columns</div>` +
          `<div><span class="muted">Numeric columns:</span> <strong>${numCols}</strong> ¬∑ <span class="muted">Categorical:</span> <strong>${catCols}</strong></div>`;
        
        // Add outlier summary
        if (Object.keys(outliersIqr).length > 0) {
          summaryHtml += `<div><span class="muted">Outliers (IQR) ‚Äì top:</span> ${renderTopOutliers(outliersIqr)}</div>`;
        }
        
        // Add correlation analysis summary
        if (corrAnalysis.overall) {
          const overall = corrAnalysis.overall;
          summaryHtml += `<div><span class="muted">Avg |correlation|:</span> <strong>${(overall.mean_absolute_correlation || 0).toFixed(3)}</strong>`;
          if (overall.max_correlation !== undefined) {
            summaryHtml += ` ¬∑ <span class="muted">Max |corr|:</span> <strong>${Math.abs(overall.max_correlation || 0).toFixed(3)}</strong>`;
          }
          summaryHtml += `</div>`;
        }
        
        // Add target correlations if available
        if (corrAnalysis.target_correlations) {
          const targetCorrs = corrAnalysis.target_correlations;
          const topTarget = Object.entries(targetCorrs).slice(0, 3);
          if (topTarget.length > 0) {
            summaryHtml += `<div><span class="muted">Top target correlations:</span> ${topTarget
              .map(([col, val]) => `<strong>${escapeHtml(col)}</strong>: ${val.toFixed(3)}`)
              .join(", ")}</div>`;
          }
        }
        
        // Add skewness/kurtosis info if available
        const skewedCols = Object.entries(numericAdvanced)
          .filter(([_, stats]) => stats.skewness !== undefined && Math.abs(stats.skewness) > 1)
          .slice(0, 3);
        if (skewedCols.length > 0) {
          summaryHtml += `<div><span class="muted">Highly skewed (|skew|>1):</span> ${skewedCols
            .map(([col, stats]) => `<strong>${escapeHtml(col)}</strong>: ${stats.skewness.toFixed(2)}`)
            .join(", ")}</div>`;
        }

        edaSummaryEl.innerHTML = summaryHtml;

        // Plots with better organization
        edaPlotsEl.innerHTML = "";
        const urls = eda.plot_urls || {};
        const keys = Object.keys(urls);
        if (!keys.length) {
          edaPlotsEl.innerHTML = "<span class='muted'>No plots generated.</span>";
          return;
        }

        // Plot labels mapping
        const plotLabels = {
          "target_distribution": "üìä Target Distribution",
          "target_correlations": "üéØ Target Correlations",
          "correlation_heatmap": "üî• Correlation Heatmap (Basic)",
          "correlation_heatmap_advanced": "üî• Correlation Heatmap (Advanced)",
          "missing_values": "‚ùå Missing Values",
          "boxplots_outliers": "üì¶ Box Plots (Outlier Detection)",
          "distributions": "üìà Feature Distributions",
          "pairplot_top_features": "üîó Pair Plot (Feature Relationships)",
        };

        // Organize plots by category
        const basicPlots = ["target_distribution", "missing_values", "target_correlations"];
        const correlationPlots = ["correlation_heatmap", "correlation_heatmap_advanced"];
        const advancedPlots = ["boxplots_outliers", "distributions", "pairplot_top_features"];

        // Render basic plots first
        basicPlots.forEach((key) => {
          if (urls[key]) {
            renderPlot(key, urls[key], plotLabels[key] || key, edaPlotsEl);
          }
        });

        // Render correlation plots
        correlationPlots.forEach((key) => {
          if (urls[key]) {
            renderPlot(key, urls[key], plotLabels[key] || key, edaPlotsEl);
            return; // Only render one correlation heatmap (prefer advanced)
          }
        });

        // Render advanced plots
        advancedPlots.forEach((key) => {
          if (urls[key]) {
            renderPlot(key, urls[key], plotLabels[key] || key, edaPlotsEl);
          }
        });

        // Render any remaining plots
        keys.forEach((key) => {
          if (!basicPlots.includes(key) && !correlationPlots.includes(key) && !advancedPlots.includes(key)) {
            renderPlot(key, urls[key], plotLabels[key] || key, edaPlotsEl);
          }
        });
      }

      function renderPlot(key, url, label, container) {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "12px";
        wrapper.style.padding = "8px";
        wrapper.style.border = "1px solid rgba(30,64,175,0.5)";
        wrapper.style.borderRadius = "8px";
        wrapper.style.background = "rgba(15,23,42,0.5)";
        
        const labelEl = document.createElement("div");
        labelEl.className = "muted";
        labelEl.style.fontSize = "12px";
        labelEl.style.fontWeight = "500";
        labelEl.style.marginBottom = "6px";
        labelEl.textContent = label;
        wrapper.appendChild(labelEl);
        
        const img = document.createElement("img");
        img.src = url;
        img.alt = key;
        img.style.maxWidth = "100%";
        img.style.borderRadius = "6px";
        img.style.border = "1px solid rgba(30,64,175,0.7)";
        img.style.display = "block";
        img.style.cursor = "pointer";
        img.onclick = () => {
          window.open(url, "_blank");
        };
        img.title = "Click to open in new tab";
        wrapper.appendChild(img);
        
        container.appendChild(wrapper);
      }

      function renderTopOutliers(outliers) {
        const entries = Object.entries(outliers || {});
        if (!entries.length) return "<span class='muted'>no numeric columns</span>";
        entries.sort((a, b) => b[1] - a[1]);
        const top = entries.slice(0, 3);
        return top
          .map(([col, cnt]) => `<strong>${escapeHtml(col)}</strong>: ${cnt}`)
          .join(", ");
      }

      // Problem Type form handler
      const problemTypeForm = document.getElementById("problem-type-form");
      const problemTypeDatasetSelect = document.getElementById("problem-type-dataset");
      const problemTypeSelect = document.getElementById("problem-type");
      const problemSubtypeRow = document.getElementById("problem-subtype-row");
      const problemSubtypeSelect = document.getElementById("problem-subtype");
      const problemTypeSubmitBtn = document.getElementById("problem-type-submit-btn");
      const problemTypeStatusEl = document.getElementById("problem-type-status");
      const problemTypeInfoEl = document.getElementById("problem-type-info");

      // Show/hide subtype based on problem type
      problemTypeSelect.addEventListener("change", (e) => {
        if (e.target.value === "classification") {
          problemSubtypeRow.style.display = "block";
          problemSubtypeSelect.required = true;
        } else {
          problemSubtypeRow.style.display = "none";
          problemSubtypeSelect.required = false;
          problemSubtypeSelect.value = "";
        }
      });

      function updateProblemTypeDatasetSelect() {
        problemTypeDatasetSelect.innerHTML = '<option value="">-- Select dataset --</option>';
        currentDatasets
          .filter((d) => d.role === "fact" || d.target_present === "yes")
          .forEach((d) => {
            const opt = document.createElement("option");
            opt.value = d.id;
            let label = `${d.filename} (${d.role})`;
            if (d.problem_type) {
              label += ` - ${d.problem_type}`;
              if (d.problem_subtype) label += ` (${d.problem_subtype})`;
            }
            opt.textContent = label;
            problemTypeDatasetSelect.appendChild(opt);
            
            // Pre-select problem type if already saved
            if (d.problem_type) {
              opt.selected = false; // Don't auto-select, but show in label
            }
          });
      }

      problemTypeForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(problemTypeForm);
        const datasetId = parseInt(formData.get("dataset_id"));
        const problemType = formData.get("problem_type");
        const problemSubtype = formData.get("problem_subtype");

        if (!datasetId || !problemType) {
          problemTypeStatusEl.textContent = "Please select dataset and problem type.";
          problemTypeStatusEl.className = "status error";
          return;
        }

        if (problemType === "classification" && !problemSubtype) {
          problemTypeStatusEl.textContent = "Please select a classification subtype.";
          problemTypeStatusEl.className = "status error";
          return;
        }

        problemTypeSubmitBtn.disabled = true;
        problemTypeStatusEl.textContent = "Saving problem type‚Ä¶";
        problemTypeStatusEl.className = "status";

        try {
          const resp = await fetch("/api/problem-type", {
            method: "POST",
            body: formData,
          });

          if (!resp.ok) {
            const errText = await resp.text();
            let msg = "Request failed: " + resp.status;
            try {
              const json = JSON.parse(errText);
              if (json.detail) msg = json.detail;
            } catch (_) {}
            throw new Error(msg);
          }

          const result = await resp.json();
          problemTypeStatusEl.textContent = `Problem type saved: ${result.problem_type}${result.problem_subtype ? ` (${result.problem_subtype})` : ""}`;
          problemTypeStatusEl.className = "status ok";
          
          // Update dataset list to reflect saved problem type
          updateProblemTypeDatasetSelect();
          
          // Refresh datasets overview
          const datasetsResp = await fetch("/api/datasets");
          if (datasetsResp.ok) {
            const datasetsData = await datasetsResp.json();
            renderDatasetsOverview(datasetsData.datasets || []);
          }
        } catch (err) {
          console.error(err);
          problemTypeStatusEl.textContent = err.message || "Failed to save problem type.";
          problemTypeStatusEl.className = "status error";
        } finally {
          problemTypeSubmitBtn.disabled = false;
        }
      });

      // Update dataset dropdown when datasets are loaded
      const originalRenderDatasets = renderDatasetsOverview;
      renderDatasetsOverview = function (datasets) {
        originalRenderDatasets(datasets);
        updateProblemTypeDatasetSelect();
      };

      // On load, try to fetch existing datasets so UI remembers previous runs
      (async () => {
        try {
          const resp = await fetch("/api/datasets");
          if (!resp.ok) return;
          const data = await resp.json();
          renderDatasetsOverview(data.datasets || []);
        } catch (e) {
          // ignore
        }
      })();
    </script>
  </body>
  </html>

